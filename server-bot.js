const OpenAI = require('openai');
const axios = require('axios');

const { Telegraf } = require('telegraf')
const { message } = require('telegraf/filters')

const bot = new Telegraf(process.env.BOT_TOKEN)
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

// Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ð½Ð½Ñ Ñ‚ÐµÐºÑÑ‚Ñƒ Ð´Ð¾ ChatGPT Ñ– Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñƒ
async function getChatGPTResponse(prompt) {
    try {
        const response = await openai.complete({
            engine: 'gpt-3.5-turbo',
            prompt: prompt,
            maxTokens: 100 // Ð—Ð¼Ñ–Ð½Ñ–Ñ‚ÑŒ Ð·Ð° Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¾ÑŽ
        });
        return response.data.choices[0].text.trim();
    } catch (error) {
        console.error('ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð²Ñ–Ð´ ChatGPT API:', error);
        return 'Ð’Ð¸Ð±Ð°Ñ‡Ñ‚Ðµ, ÑÑ‚Ð°Ð»Ð°ÑÑ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°. Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, ÑÐ¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ–Ð·Ð½Ñ–ÑˆÐµ.';
    }
}

//==================================================================================================
//Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ñ‰Ð¾ Ð´Ð°Ñ” Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¿Ð¾Ð³Ð¾Ð´Ð¸ Ð² Ð¿ÐµÐ²Ð½Ð¾Ð¼Ñƒ Ð¼Ñ–ÑÑ‚Ñ–
async function getWeather(city) {
    const apiKey = process.env.WEATHER_API_KEY;
    const url = `http://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

    try {
        const response = await axios.get(url);
        const data = response.data; // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð´Ð°Ð½Ñ– Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñƒ Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ

        if (data.cod === 200) {
            const weatherID = data.weather[0].id;
            const temperature = data.main.temp;

            weather = translateWeather( weatherID );// ÐŸÐµÑ€ÐµÐºÐ»Ð°Ð´ Ñ‡ÐµÑ€ÐµÐ· id
            return `ÐŸÐ¾Ð³Ð¾Ð´Ð° Ñƒ Ð¼Ñ–ÑÑ‚Ñ– ${city}: ${weather}, Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°: ${temperature}Â°C`;
        } else {
            return 'ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¿Ð¾Ð³Ð¾Ð´Ð¸. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‰Ðµ Ñ€Ð°Ð·.';
        }
    } catch (error) {
        console.error('ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°:', error);
        return 'Ð¡Ñ‚Ð°Ð»Ð°ÑÑ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ– Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ñƒ Ð¿Ð¾Ð³Ð¾Ð´Ð¸.';
    }
}
const WEATHER_DICTIONARY = {
    "200": "Ð“Ñ€Ð¾Ð·Ð° Ð· Ð½ÐµÐ²ÐµÐ»Ð¸ÐºÐ¸Ð¼ Ð´Ð¾Ñ‰ÐµÐ¼",
    "201": "Ð“Ñ€Ð¾Ð·Ð° Ð· Ð´Ð¾Ñ‰ÐµÐ¼",
    "202": "Ð“Ñ€Ð¾Ð·Ð° Ð· ÑÐ¸Ð»ÑŒÐ½Ð¸Ð¼ Ð´Ð¾Ñ‰ÐµÐ¼",
    "210": "Ð›ÐµÐ³ÐºÐ° Ð³Ñ€Ð¾Ð·Ð°",
    "211": "Ð“Ñ€Ð¾Ð·Ð°",
    "212": "Ð¡Ð¸Ð»ÑŒÐ½Ð° Ð³Ñ€Ð¾Ð·Ð°",
    "221": "Ð Ð¾Ð·Ñ€Ñ–Ð´Ð¶ÐµÐ½Ð° Ð³Ñ€Ð¾Ð·Ð°",
    "230": "Ð“Ñ€Ð¾Ð·Ð° Ð· Ð»ÐµÐ³ÐºÐ¾ÑŽ Ð¼Ñ€ÑÐºÐ¾ÑŽ",
    "231": "Ð“Ñ€Ð¾Ð·Ð° Ð· Ð¼Ñ€ÑÐºÐ¾ÑŽ",
    "232": "Ð“Ñ€Ð¾Ð·Ð° Ð· ÑÐ¸Ð»ÑŒÐ½Ð¾ÑŽ Ð¼Ñ€ÑÐºÐ¾ÑŽ",
    "300": "Ð›ÐµÐ³ÐºÐ° Ð¼Ñ€ÑÐºÐ°",
    "301": "ÐœÑ€ÑÐºÐ°",
    "302": "Ð¡Ð¸Ð»ÑŒÐ½Ð° Ð¼Ñ€ÑÐºÐ°",
    "310": "Ð›ÐµÐ³ÐºÐ° Ð¼Ñ€ÑÐºÐ° Ð´Ð¾Ñ‰",
    "311": "ÐœÑ€ÑÐºÐ° Ð´Ð¾Ñ‰",
    "312": "Ð¡Ð¸Ð»ÑŒÐ½Ð¸Ð¹ Ð¼Ñ€ÑÐºÐ° Ð´Ð¾Ñ‰",
    "313": "Ð”Ð¾Ñ‰ Ñ–Ð· Ð¼Ñ€ÑÐºÐ¾ÑŽ",
    "314": "Ð¡Ð¸Ð»ÑŒÐ½Ð¸Ð¹ Ð´Ð¾Ñ‰ Ñ–Ð· Ð¼Ñ€ÑÐºÐ¾ÑŽ",
    "321": "Ð›ÐµÐ³ÐºÐ¸Ð¹ Ð¼Ñ€ÑÐºÐ° Ð· Ð´Ð¾Ñ‰ÐµÐ¼",
    "500": "Ð›ÐµÐ³ÐºÐ¸Ð¹ Ð´Ð¾Ñ‰",
    "501": "ÐœÐ°Ñ‚ÐµÑ€Ñ–Ð°Ð» Ð´Ð¾Ñ‰",
    "502": "Ð¡Ð¸Ð»ÑŒÐ½Ð¸Ð¹ Ð´Ð¾Ñ‰",
    "503": "Ð”ÑƒÐ¶Ðµ ÑÐ¸Ð»ÑŒÐ½Ð¸Ð¹ Ð´Ð¾Ñ‰",
    "504": "Ð•ÐºÑÑ‚Ñ€ÐµÐ¼Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ð´Ð¾Ñ‰",
    "511": "Ð›ÐµÐ´ÑÐ½Ð¸Ð¹ Ð´Ð¾Ñ‰",
    "520": "Ð›ÐµÐ³ÐºÐ° Ð·Ð»Ð¸Ð²Ð°",
    "521": "Ð Ð¾Ð·Ñ€Ñ–Ð´Ð¶ÐµÐ½Ð° Ð·Ð»Ð¸Ð²Ð°",
    "522": "Ð¡Ð¸Ð»ÑŒÐ½Ð° Ð·Ð»Ð¸Ð²Ð°",
    "531": "Ð Ð¾Ð·Ñ€Ñ–Ð´Ð¶ÐµÐ½Ð° Ð·Ð»Ð¸Ð²Ð°",
    "600": "Ð›ÐµÐ³ÐºÐ¸Ð¹ ÑÐ½Ñ–Ð³",
    "601": "Ð¡Ð½Ñ–Ð³",
    "602": "Ð¡Ð¸Ð»ÑŒÐ½Ð¸Ð¹ ÑÐ½Ñ–Ð³",
    "611": "Ð”Ð¾Ñ‰ Ñ–Ð· ÑÐ½Ñ–Ð³Ð¾Ð¼",
    "612": "Ð”Ð¾Ñ‰ Ñ–Ð· ÑÐ¼Ñ–ÑˆÐ°Ð½Ð¸Ð¼ Ð´Ð¾Ñ‰ÐµÐ¼ Ñ– ÑÐ½Ñ–Ð³Ð¾Ð¼",
    "613": "Ð¡Ð½Ñ–Ð³Ð¾Ð²Ð¸Ð¹ Ð´Ð¾Ñ‰",
    "615": "Ð›ÐµÐ³ÐºÐ¸Ð¹ Ð´Ð¾Ñ‰ Ñ–Ð· ÑÐ½Ñ–Ð³Ð¾Ð¼",
    "616": "Ð”Ð¾Ñ‰ Ñ–Ð· ÑÐ½Ñ–Ð³Ð¾Ð¼",
    "620": "Ð›ÐµÐ³ÐºÐ¸Ð¹ ÑÐ½Ñ–Ð³",
    "621": "Ð¡Ð½Ñ–Ð³",
    "622": "Ð¡Ð¸Ð»ÑŒÐ½Ð¸Ð¹ ÑÐ½Ñ–Ð³",
    "701": "Ð¢ÑƒÐ¼Ð°Ð½",
    "711": "Ð”Ð¸Ð¼",
    "721": "Ð›ÐµÐ³ÐºÐ¸Ð¹ Ñ‚ÑƒÐ¼Ð°Ð½",
    "731": "ÐŸÐ¸Ð»",
    "741": "Ð¢ÑƒÐ¼Ð°Ð½",
    "751": "ÐŸÑ–Ñ‰Ð°Ð½Ð¾-Ð¿Ð¸Ð»Ð¾Ð²Ð¸Ð¹ Ð²Ð¸Ñ…Ð¾Ñ€",
    "761": "ÐŸÐ¸Ð»ÐµÐ²Ð¸Ð¹ Ð²Ð¸Ñ…Ð¾Ñ€",
    "762": "Ð’ÑƒÐ»ÐºÐ°Ð½Ñ–Ñ‡Ð½Ð¸Ð¹ Ð¿Ð¾Ð¿Ñ–Ð»",
    "771": "Ð¨Ñ‚Ð¾Ñ€Ð¼",
    "781": "Ð¢Ð¾Ñ€Ð½Ð°Ð´Ð¾",
    "800": "Ð¡Ð¾Ð½ÑÑ‡Ð½Ð¾",
    "801": "ÐœÑ–ÑÑŒÑ†ÑÐ¼Ð¸ Ñ…Ð¼Ð°Ñ€Ð¸",
    "802": "Ð Ð¾Ð·ÑÑ–ÑÐ½Ñ– Ñ…Ð¼Ð°Ñ€Ð¸",
    "803": "Ð¥Ð¼Ð°Ñ€Ð½Ðµ Ð½ÐµÐ±Ð¾",
    "804": "Ð—Ð°Ñ‚ÑŒÐ¼Ð°Ñ€ÐµÐ½Ðµ Ð½ÐµÐ±Ð¾",
};
function translateWeather(weatherID) {
    return WEATHER_DICTIONARY[ weatherID ] || "ÐÐµÐ²Ñ–Ð´Ð¾Ð¼Ð° Ð¿Ð¾Ð³Ð¾Ð´Ð°";
}

bot.command('weather', async (ctx) => {
    const city = ctx.message.text.split(' ').slice(1).join(' '); // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð½Ð°Ð·Ð²Ñƒ Ð¼Ñ–ÑÑ‚Ð° Ð· Ñ‚ÐµÐºÑÑ‚Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸
    try {
        const weatherInfo = await getWeather(city);
        ctx.reply(weatherInfo);
    } catch (error) {
        ctx.reply('Ð¡Ñ‚Ð°Ð»Ð°ÑÑ Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ– Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ñƒ Ð¿Ð¾Ð³Ð¾Ð´Ð¸.');
        console.log(error)
    }
});
//====================================================================================================

bot.start((ctx) => ctx.reply('Welcome'))
bot.help((ctx) => ctx.reply('Send me a sticker'))
bot.on(message('sticker'), (ctx) => ctx.reply('ðŸ‘'))
bot.hears('hi', (ctx) => ctx.reply('Hey there'))
bot.hears('How are you?', (ctx) => ctx.reply('Great'))

// ÐžÐ±Ñ€Ð¾Ð±Ð½Ð¸Ðº Ð²Ñ…Ñ–Ð´Ð½Ð¸Ñ… Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ Ð±Ð¾Ñ‚Ð°
bot.hears('gpt', async (ctx) => {
    const userMessage = ctx.message.text;

    // ÐžÑ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð²Ñ–Ð´ ChatGPT Ð·Ð° Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð¾ÑŽ Ð²Ð²ÐµÐ´ÐµÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
    const chatGPTResponse = await getChatGPTResponse(userMessage);

    // ÐÐ°Ð´ÑÐ¸Ð»Ð°Ñ”Ð¼Ð¾ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ñƒ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ÐµÐ²Ñ–
    ctx.reply(chatGPTResponse);
});

bot.launch({
    webhook: {
        domain: process.env.WEBHOOK_DOMAIN,
        port: process.env.PORT,
    },
})

// ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ñƒ SIGINT
process.once('SIGINT', () => {
    bot.stop('SIGINT');
    console.log('Bot stopped gracefully on SIGINT');
});

// ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ñƒ SIGTERM
process.once('SIGTERM', () => {
    bot.stop('SIGTERM');
    console.log('Bot stopped gracefully on SIGTERM');
});
